# PWA (Progressive Web App) Implementation

## Overview

This document describes the PWA features implemented for LCF Auto Performance application, making it installable on devices and functional offline.

## Features Implemented

### 1. Web App Manifest (`/public/manifest.json`)

The manifest file enables the application to be installed on devices as a Progressive Web App with the following characteristics:

- **Name**: LCF Auto Performance
- **Short Name**: LCF Auto
- **Theme Color**: #1CCEFF (brand accent color)
- **Background Color**: #FFFFFF
- **Display Mode**: Standalone (fullscreen app experience)
- **Icons**: Multiple sizes (72x72 to 512x512) for various devices
- **Language**: French (fr)

### 2. Service Worker

The service worker is automatically generated by `next-pwa` and provides:

- **Offline Functionality**: Caches assets for offline access
- **Performance Optimization**: Caches frequently accessed resources
- **Auto-update**: Updates cache when new versions are deployed

### 3. Caching Strategy

Different caching strategies are applied based on resource types:

#### Cache-First Strategy
- Google Fonts webfonts (cached for 365 days)
- Audio files (MP3, WAV, OGG)
- Video files (MP4)

#### Stale-While-Revalidate Strategy
- Google Fonts stylesheets (cached for 7 days)
- Font files (EOT, OTF, TTF, WOFF, WOFF2)
- Images (JPG, JPEG, GIF, PNG, SVG, ICO, WEBP) - 24 hours
- Next.js optimized images
- JavaScript files (24 hours)
- CSS files (24 hours)
- Next.js data files (24 hours)

#### Network-First Strategy
- JSON, XML, CSV files (24 hours)
- Same-origin pages (24 hours, 10s timeout)
- API routes are excluded from caching

### 4. PWA Icons

Icons generated from the logo in multiple sizes:
- 72x72, 96x96, 128x128, 144x144, 152x152, 192x192, 384x384, 512x512

All icons support both `any` and `maskable` purposes for better compatibility across platforms.

### 5. Offline Fallback Page

A dedicated offline page (`/offline`) is available when users lose network connectivity. It displays:
- Information about offline status
- Available features (cached pages, contact info, services)
- Unavailable features (appointments, vehicles, authentication)
- Retry button to check connection

### 6. Metadata & Meta Tags

The application includes proper PWA metadata:
- Manifest link in HTML head
- Theme color meta tag
- Apple Touch Icon for iOS devices
- Viewport settings optimized for mobile
- Apple Web App configuration

## Installation

### Desktop (Chrome/Edge)
1. Visit the application URL
2. Click the install icon in the address bar
3. Click "Install" in the popup

### Mobile (Android)
1. Open the application in Chrome
2. Tap the menu (three dots)
3. Select "Add to Home screen"
4. Tap "Install"

### Mobile (iOS/Safari)
1. Open the application in Safari
2. Tap the Share button
3. Scroll and tap "Add to Home Screen"
4. Tap "Add"

## Testing PWA Features

### Testing Installation
1. Open Chrome DevTools
2. Go to Application tab
3. Click "Manifest" to verify manifest is loaded
4. Check "Service Workers" to see registered worker

### Testing Offline Functionality
1. Open the application
2. Browse a few pages
3. Open Chrome DevTools > Network tab
4. Select "Offline" from throttling dropdown
5. Navigate through the app - cached pages should still load
6. Try accessing uncached pages - should show offline page

### Testing Service Worker
1. Open Chrome DevTools > Application > Service Workers
2. Verify worker is registered and running
3. Click "Update" to manually update
4. Check "Offline" to test offline mode

## Configuration

### Build Configuration

The PWA is configured in `next.config.ts` using `next-pwa`:

```typescript
withPWA({
  dest: "public",
  disable: process.env.NODE_ENV === "development",
  register: true,
  skipWaiting: true,
  runtimeCaching: [...]
})
```

### Development Mode

Service worker is **disabled in development** to avoid caching issues during development.

### Production Build

To build with PWA support:
```bash
npm run build -- --webpack
```

Note: The `--webpack` flag is required because Next.js 16 uses Turbopack by default, but next-pwa requires webpack.

## Files Structure

```
/public
  /icons
    icon-72x72.png
    icon-96x96.png
    ...
    icon-512x512.png
  manifest.json
  sw.js (auto-generated)
  workbox-*.js (auto-generated)

/src/app
  /offline
    page.tsx

/scripts
  generate-icons.js

next.config.ts (PWA configuration)
```

## Best Practices Implemented

1. **Minimal Cache Duration**: Assets cached for appropriate durations (24h - 365 days)
2. **Cache Limits**: Reasonable maxEntries to prevent excessive storage use
3. **Network-First for Dynamic Content**: API routes and dynamic pages use network-first strategy
4. **Proper Error Handling**: Offline fallback page for failed requests
5. **Auto-Update**: Service worker updates automatically when new version is deployed
6. **Skip Waiting**: New service worker activates immediately

## Browser Support

The PWA features are supported in:
- ✅ Chrome/Edge (Desktop & Mobile)
- ✅ Firefox (Desktop & Mobile)
- ✅ Safari (iOS 11.3+)
- ✅ Samsung Internet
- ⚠️ Safari (macOS) - Limited support

## Troubleshooting

### Service Worker Not Registering
- Clear browser cache and service workers
- Ensure HTTPS is enabled (required for service workers)
- Check Console for errors

### App Not Installing
- Verify manifest.json is accessible at /manifest.json
- Check all required manifest fields are present
- Ensure icons are accessible

### Offline Mode Not Working
- Verify service worker is active in DevTools
- Check if pages were visited before going offline
- Ensure proper cache strategies are configured

### Updates Not Applying
- Hard refresh the page (Ctrl+F5 or Cmd+Shift+R)
- Unregister service worker in DevTools and refresh
- Clear site data and reload

## Future Enhancements

Potential improvements for the PWA:

1. **Push Notifications**: Firebase Cloud Messaging for appointment reminders
2. **Background Sync**: Queue appointment bookings when offline
3. **Periodic Background Sync**: Sync data periodically in background
4. **Install Prompt**: Custom UI for install prompt
5. **Update Notification**: Alert users when new version is available
6. **Offline Form Data**: Save form data when offline and sync when online
7. **App Shortcuts**: Quick actions from home screen icon

## Security Considerations

- Service worker only works over HTTPS (Firebase Hosting provides this)
- Cache is scoped to origin (prevents cross-site data access)
- API routes are not cached to prevent stale authentication tokens
- Sensitive data should never be cached

## Performance Impact

- **Initial Load**: +~10KB for service worker registration
- **Subsequent Loads**: Significantly faster due to caching
- **Offline Access**: Full functionality for cached pages
- **Storage Usage**: Automatically managed by browser with size limits

## Compliance

The PWA implementation follows:
- Google's PWA guidelines
- Web App Manifest specification
- Service Worker specification
- Accessibility standards (WCAG 2.1 AA)

## References

- [Next PWA Documentation](https://github.com/shadowwalker/next-pwa)
- [PWA Guidelines](https://web.dev/progressive-web-apps/)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Web App Manifest](https://developer.mozilla.org/en-US/docs/Web/Manifest)

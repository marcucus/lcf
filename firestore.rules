rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isAgendaManager() {
      return hasRole('agendaManager');
    }
    
    function isAdminOrManager() {
      return isAdmin() || isAgendaManager();
    }
    
    // Helper function to check 24-hour rule for appointments
    // Note: This is a first layer of defense. Cloud Functions provide the authoritative check.
    function canModifyAppointment(appointmentData) {
      let appointmentTime = appointmentData.dateTime;
      let now = request.time;
      let diffInHours = (appointmentTime - now) / duration.value(1, 'h');
      
      // Admin and agenda managers can always modify
      if (isAdminOrManager()) {
        return true;
      }
      
      // Regular users need more than 24 hours
      return diffInHours > 24;
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isOwner(userId);
      
      // Users can create their own document on signup
      allow create: if isSignedIn() && request.auth.uid == userId 
                    && request.resource.data.role == 'user';
      
      // Users can update their own profile, notification preferences, and FCM token
      allow update: if isOwner(userId) 
                    && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
                    || isAdmin();
      
      // Only admins can delete users
      allow delete: if isAdmin();
      
      // Admins can read all users
      allow read: if isAdmin();
      
      // Admins can update user roles
      allow update: if isAdmin();
    }
    
    // Appointments collection
    match /appointments/{appointmentId} {
      // Users can read their own appointments
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid 
        || isAdminOrManager()
      );
      
      // Users can create appointments for themselves
      allow create: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid
        || isAdminOrManager()
      );
      
      // Users can update/cancel their own appointments (24h rule enforced in client/functions)
      // Admins and managers can update any appointment
      allow update: if isSignedIn() && (
        (resource.data.userId == request.auth.uid && canModifyAppointment(resource.data))
        || isAdminOrManager()
      );
      
      // Only admins and managers can delete appointments
      allow delete: if isAdminOrManager();
      
      // Admins and managers can read all appointments
      allow list: if isAdminOrManager();
    }
    
    // Vehicles collection
    match /vehicles/{vehicleId} {
      // Everyone can read vehicles
      allow read: if true;
      
      // Only admins can create, update, or delete vehicles
      allow create, update, delete: if isAdmin();
    }
    
    // Response templates collection (for Google reviews)
    match /responseTemplates/{templateId} {
      // Only admins can read/write response templates
      allow read, write: if isAdmin();
    }
    
    // Google reviews collection (cached reviews)
    match /googleReviews/{reviewId} {
      // Only admins can read/write reviews
      allow read, write: if isAdmin();
    }
    
    // Invoices collection
    match /invoices/{invoiceId} {
      // Users can read their own invoices
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid 
        || isAdmin()
      );
      
      // Only admins can create, update, or delete invoices
      allow create, update, delete: if isAdmin();
      
      // Admins can read all invoices
      allow list: if isAdmin();
    }
    
      // Only admins can read invoices
      allow read: if isAdmin();
      
      // Only admins can create invoices
      allow create: if isAdmin() 
                    && request.resource.data.createdBy == request.auth.uid;
      
      // Only admins can update invoices
      allow update: if isAdmin();
      
      // Only admins can delete invoices
      allow delete: if isAdmin();
    }
    
    // User vehicles collection (for storing customer vehicle info)
    match /userVehicles/{vehicleId} {
      // Users can read their own vehicles
    // Quotations collection
    match /quotations/{quotationId} {
      // Only admins can manage quotations
      allow read, write: if isAdmin();
      
      // Users can read their own quotations if linked to their userId
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
    // Quotes collection
    match /quotes/{quoteId} {
      // Users can read their own quotes
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid 
        || isAdmin()
      );
      
      // Only admins can create, update, or delete quotes
      allow create, update, delete: if isAdmin();
      
      // Admins can read all quotes
      allow list: if isAdmin();
        || isAdminOrManager()
      );
      
      // Only admins and managers can create quotes
      allow create: if isAdminOrManager();
      
      // Only admins and managers can update quotes
      allow update: if isAdminOrManager();
      
      // Only admins and managers can delete quotes
      allow delete: if isAdminOrManager();
      
      // Admins and managers can list all quotes
      allow list: if isAdminOrManager();
    }
    
    // Invoices collection
    match /invoices/{invoiceId} {
      // Users can read their own invoices
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid 
        || isAdminOrManager()
      );
      
      // Users can create their own vehicle records
      allow create: if isSignedIn() && (
        request.resource.data.userId == request.auth.uid
        || isAdminOrManager()
      );
      
      // Users can update their own vehicles
      allow update: if isSignedIn() && (
        resource.data.userId == request.auth.uid
        || isAdminOrManager()
      );
      
      // Admins can read all user vehicles
      // Only admins and managers can create invoices
      allow create: if isAdminOrManager();
      
      // Only admins and managers can update invoices
      allow update: if isAdminOrManager();
      
      // Only admins and managers can delete invoices
      allow delete: if isAdminOrManager();
      
      // Admins and managers can list all invoices
      allow list: if isAdminOrManager();
    }
  }
}
